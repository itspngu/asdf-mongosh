#!/bin/bash

set -e

: "${ASDF_INSTALL_VERSION:?"Missing ASDF_INSTALL_VERSION"}"
: "${ASDF_DOWNLOAD_PATH:?"Missing ASDF_DOWNLOAD_PATH"}"

case "$(uname -s)" in
  "Darwin")
    case "$(uname -m)" in
      "x86_64")
        RELEASE_FILENAME="mongosh-$ASDF_INSTALL_VERSION-darwin-x64.zip"
        ;;
      "arm64")
        RELEASE_FILENAME="mongosh-$ASDF_INSTALL_VERSION-darwin-arm64.zip"
        ;;
      *)
        "Unknown machine hardware" 1>&2 && exit 1
        ;;
    esac
    ;;
  "Linux")
    RELEASE_FILENAME="mongosh-$ASDF_INSTALL_VERSION-linux.tgz"
    ;;
  *)
    echo "Unknown operating system" 1>&2 && exit 1
    ;;
esac

(
  curl -fsSL "https://github.com/mongodb-js/mongosh/releases/download/v$ASDF_INSTALL_VERSION/$RELEASE_FILENAME" |
    tar xzf - -C "$ASDF_DOWNLOAD_PATH" &&
    exit 0
) || (
  echo "Download failed" 1>&2 &&
    rm -rf "$ASDF_DOWNLOAD_PATH" &&
    exit 1
)
